using System.Linq;
using System.Xml;
using Shouldly;
using ShowplanSpy.SqlMonitor;
using Xunit;

namespace ShowplanSpy.Tests
{
    public class ShowplanFixerTests
    {
        [Fact]
        public void SqlStatementsWithParamsAreCleaned()
        {
            var original =
                @"(@__p_0 int)SELECT [t].[CommentID] AS [Id], [i.User].[UserName] AS [PostedBy], [t].[CommentDate] AS [PostedDate], [t].[Comment] AS [Text]
FROM (
    SELECT TOP(@__p_0) [c].*
    FROM [Comments] AS [c]
) AS [t]
INNER JOIN [Users] AS [i.User] ON [t].[UserID] = [i.User].[UserID]
ORDER BY [Id] DESC";
            var afterStripShouldBe =
                @"SELECT [t].[CommentID] AS [Id], [i.User].[UserName] AS [PostedBy], [t].[CommentDate] AS [PostedDate], [t].[Comment] AS [Text]
FROM (
    SELECT TOP(@__p_0) [c].*
    FROM [Comments] AS [c]
) AS [t]
INNER JOIN [Users] AS [i.User] ON [t].[UserID] = [i.User].[UserID]
ORDER BY [Id] DESC";

            var after = ShowplanFixer.StripParamsFromSqlStatement(original);
            after.ShouldBe(afterStripShouldBe);
        }

        [Fact]
        public void SqlStatementWithoutParamAreNotStripped()
        {
            const string sql = "SELECT * FROM Users";
            var after = ShowplanFixer.StripParamsFromSqlStatement(sql);
            after.ShouldBe(sql);
        }

        [Fact]
        public void Can_fix_up_showplan_with_better_statement_details()
        {
            const string originalShowplan = "<ShowPlanXML xmlns=\"http://schemas.microsoft.com/sqlserver/2004/07/showplan\" Version=\"1.6\" Build=\"14.0.1000.169\"><BatchSequence><Batch><Statements><StmtSimple StatementSubTreeCost=\"0.00334715\" StatementEstRows=\"5\" SecurityPolicyApplied=\"false\" StatementOptmLevel=\"TRIVIAL\" QueryHash=\"0x1BBA1917F307A0B7\" QueryPlanHash=\"0xD8B9D2461B0B7537\" CardinalityEstimationModelVersion=\"140\"><QueryPlan DegreeOfParallelism=\"1\" CachedPlanSize=\"24\" CompileTime=\"0\" CompileCPU=\"0\" CompileMemory=\"112\"><MemoryGrantInfo SerialRequiredMemory=\"0\" SerialDesiredMemory=\"0\"></MemoryGrantInfo><OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant=\"209144\" EstimatedPagesCached=\"209144\" EstimatedAvailableDegreeOfParallelism=\"8\" MaxCompileMemory=\"13102120\"></OptimizerHardwareDependentProperties><QueryTimeStats ElapsedTime=\"0\" CpuTime=\"0\"></QueryTimeStats><RelOp NodeId=\"0\" PhysicalOp=\"Top\" LogicalOp=\"Top\" EstimateRows=\"5\" EstimateIO=\"0\" EstimateCPU=\"5e-007\" AvgRowSize=\"4468\" EstimatedTotalSubtreeCost=\"0.00334715\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\"></ColumnReference></OutputList><RunTimeInformation><RunTimeCountersPerThread Thread=\"0\" ActualRows=\"5\" Batches=\"0\" ActualExecutionMode=\"Row\" ActualElapsedms=\"0\" ActualCPUms=\"0\" ActualEndOfScans=\"1\" ActualExecutions=\"1\"></RunTimeCountersPerThread></RunTimeInformation><Top RowCount=\"0\" IsPercent=\"0\" WithTies=\"0\"><TopExpression><ScalarOperator ScalarString=\"(5)\"><Const ConstValue=\"(5)\"></Const></ScalarOperator></TopExpression><RelOp NodeId=\"1\" PhysicalOp=\"Clustered Index Scan\" LogicalOp=\"Clustered Index Scan\" EstimateRows=\"5\" EstimatedRowsRead=\"524491\" EstimateIO=\"7.75868\" EstimateCPU=\"0.577097\" AvgRowSize=\"4468\" EstimatedTotalSubtreeCost=\"0.00334665\" TableCardinality=\"524491\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\"></ColumnReference></OutputList><RunTimeInformation><RunTimeCountersPerThread Thread=\"0\" ActualRows=\"5\" Batches=\"0\" ActualExecutionMode=\"Row\" ActualElapsedms=\"0\" ActualCPUms=\"0\" ActualScans=\"1\" ActualLogicalReads=\"22\" ActualPhysicalReads=\"0\" ActualReadAheads=\"0\" ActualLobLogicalReads=\"0\" ActualLobPhysicalReads=\"0\" ActualLobReadAheads=\"0\" ActualRowsRead=\"5\" ActualEndOfScans=\"0\" ActualExecutions=\"1\"></RunTimeCountersPerThread></RunTimeInformation><IndexScan Ordered=\"0\" ForcedIndex=\"0\" ForceScan=\"0\" NoExpandHint=\"0\" Storage=\"RowStore\"><DefinedValues><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\"></ColumnReference></DefinedValue></DefinedValues><Object Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Index=\"[PK_Users_Id]\" IndexKind=\"Clustered\" Storage=\"RowStore\"></Object></IndexScan></RelOp></Top></RelOp></QueryPlan></StmtSimple></Statements></Batch></BatchSequence></ShowPlanXML>";
            const string fromQueryStoreShowplan = "<ShowPlanXML xmlns=\"http://schemas.microsoft.com/sqlserver/2004/07/showplan\" Version=\"1.6\" Build=\"14.0.1000.169\"><BatchSequence><Batch><Statements><StmtSimple StatementText=\"select top 5 * from users\" StatementId=\"1\" StatementCompId=\"1\" StatementType=\"SELECT\" RetrievedFromCache=\"true\" StatementSubTreeCost=\"0.00334715\" StatementEstRows=\"5\" SecurityPolicyApplied=\"false\" StatementOptmLevel=\"TRIVIAL\" QueryHash=\"0x1BBA1917F307A0B7\" QueryPlanHash=\"0xD8B9D2461B0B7537\" CardinalityEstimationModelVersion=\"140\"><StatementSetOptions QUOTED_IDENTIFIER=\"true\" ARITHABORT=\"true\" CONCAT_NULL_YIELDS_NULL=\"true\" ANSI_NULLS=\"true\" ANSI_PADDING=\"true\" ANSI_WARNINGS=\"true\" NUMERIC_ROUNDABORT=\"false\" /><QueryPlan CachedPlanSize=\"24\" CompileTime=\"0\" CompileCPU=\"0\" CompileMemory=\"112\"><MemoryGrantInfo SerialRequiredMemory=\"0\" SerialDesiredMemory=\"0\" /><OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant=\"209144\" EstimatedPagesCached=\"209144\" EstimatedAvailableDegreeOfParallelism=\"8\" MaxCompileMemory=\"13102120\" /><RelOp NodeId=\"0\" PhysicalOp=\"Top\" LogicalOp=\"Top\" EstimateRows=\"5\" EstimateIO=\"0\" EstimateCPU=\"5e-007\" AvgRowSize=\"4468\" EstimatedTotalSubtreeCost=\"0.00334715\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\" /></OutputList><Top RowCount=\"0\" IsPercent=\"0\" WithTies=\"0\"><TopExpression><ScalarOperator ScalarString=\"(5)\"><Const ConstValue=\"(5)\" /></ScalarOperator></TopExpression><RelOp NodeId=\"1\" PhysicalOp=\"Clustered Index Scan\" LogicalOp=\"Clustered Index Scan\" EstimateRows=\"5\" EstimatedRowsRead=\"524491\" EstimateIO=\"7.75868\" EstimateCPU=\"0.577097\" AvgRowSize=\"4468\" EstimatedTotalSubtreeCost=\"0.00334665\" TableCardinality=\"524491\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\" /></OutputList><IndexScan Ordered=\"0\" ForcedIndex=\"0\" ForceScan=\"0\" NoExpandHint=\"0\" Storage=\"RowStore\"><DefinedValues><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\" /></DefinedValue></DefinedValues><Object Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Index=\"[PK_Users_Id]\" IndexKind=\"Clustered\" Storage=\"RowStore\" /></IndexScan></RelOp></Top></RelOp></QueryPlan></StmtSimple><StmtSimple StatementText=\"&#xD;&#xA;select top 5 * from posts\" StatementId=\"2\" StatementCompId=\"2\" StatementType=\"SELECT\" RetrievedFromCache=\"true\" StatementSubTreeCost=\"0.00399609\" StatementEstRows=\"5\" SecurityPolicyApplied=\"false\" StatementOptmLevel=\"TRIVIAL\" QueryHash=\"0xA412098E2F9DD081\" QueryPlanHash=\"0xFA74B1C0F38BCAFE\" CardinalityEstimationModelVersion=\"140\"><StatementSetOptions QUOTED_IDENTIFIER=\"true\" ARITHABORT=\"true\" CONCAT_NULL_YIELDS_NULL=\"true\" ANSI_NULLS=\"true\" ANSI_PADDING=\"true\" ANSI_WARNINGS=\"true\" NUMERIC_ROUNDABORT=\"false\" /><QueryPlan CachedPlanSize=\"24\" CompileTime=\"0\" CompileCPU=\"0\" CompileMemory=\"144\"><MemoryGrantInfo SerialRequiredMemory=\"0\" SerialDesiredMemory=\"0\" /><OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant=\"209144\" EstimatedPagesCached=\"209144\" EstimatedAvailableDegreeOfParallelism=\"8\" MaxCompileMemory=\"13102120\" /><RelOp NodeId=\"0\" PhysicalOp=\"Top\" LogicalOp=\"Top\" EstimateRows=\"5\" EstimateIO=\"0\" EstimateCPU=\"5e-007\" AvgRowSize=\"4567\" EstimatedTotalSubtreeCost=\"0.00399609\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\" /></OutputList><Top RowCount=\"0\" IsPercent=\"0\" WithTies=\"0\"><TopExpression><ScalarOperator ScalarString=\"(5)\"><Const ConstValue=\"(5)\" /></ScalarOperator></TopExpression><RelOp NodeId=\"1\" PhysicalOp=\"Clustered Index Scan\" LogicalOp=\"Clustered Index Scan\" EstimateRows=\"5\" EstimatedRowsRead=\"2.55001e+006\" EstimateIO=\"451.41\" EstimateCPU=\"2.80517\" AvgRowSize=\"4567\" EstimatedTotalSubtreeCost=\"0.00399559\" TableCardinality=\"2.55001e+006\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\" /></OutputList><IndexScan Ordered=\"0\" ForcedIndex=\"0\" ForceScan=\"0\" NoExpandHint=\"0\" Storage=\"RowStore\"><DefinedValues><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\" /></DefinedValue></DefinedValues><Object Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Index=\"[PK_Posts__Id]\" IndexKind=\"Clustered\" Storage=\"RowStore\" /></IndexScan></RelOp></Top></RelOp></QueryPlan></StmtSimple></Statements></Batch></BatchSequence></ShowPlanXML>";

            var better = ShowplanFixer.ApplyBetterStatement(originalShowplan, fromQueryStoreShowplan, out var statementText);

            statementText.ShouldBe("select top 5 * from users");

            var xml = new XmlDocument();
            xml.LoadXml(better);

            var statement = xml.GetElementsByTagName("StmtSimple")[0];

            statement.Name.ShouldBe("StmtSimple");
            statement.Attributes?["StatementText"].ShouldNotBeNull();
            statement.Attributes?["StatementText"].Value.ShouldBe("select top 5 * from users");
            
            var setOptions = statement.ChildNodes.Cast<XmlNode>().FirstOrDefault(i => i.Name == "StatementSetOptions");
            setOptions.ShouldNotBeNull();
            setOptions.Attributes?.Count.ShouldBe(8);
        }

        [Fact]
        public void Can_fix_up_showplan_with_better_statement_details_with_the_other_statement()
        {
            const string originalShowPlan = "<ShowPlanXML xmlns=\"http://schemas.microsoft.com/sqlserver/2004/07/showplan\" Version=\"1.6\" Build=\"14.0.1000.169\"><BatchSequence><Batch><Statements><StmtSimple StatementSubTreeCost=\"0.00399609\" StatementEstRows=\"5\" SecurityPolicyApplied=\"false\" StatementOptmLevel=\"TRIVIAL\" QueryHash=\"0xA412098E2F9DD081\" QueryPlanHash=\"0xFA74B1C0F38BCAFE\" CardinalityEstimationModelVersion=\"140\"><QueryPlan DegreeOfParallelism=\"1\" CachedPlanSize=\"24\" CompileTime=\"0\" CompileCPU=\"0\" CompileMemory=\"144\"><MemoryGrantInfo SerialRequiredMemory=\"0\" SerialDesiredMemory=\"0\"></MemoryGrantInfo><OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant=\"209144\" EstimatedPagesCached=\"209144\" EstimatedAvailableDegreeOfParallelism=\"8\" MaxCompileMemory=\"13102120\"></OptimizerHardwareDependentProperties><WaitStats><Wait WaitType=\"ASYNC_NETWORK_IO\" WaitTimeMs=\"85\" WaitCount=\"1\"></Wait></WaitStats><QueryTimeStats ElapsedTime=\"86\" CpuTime=\"0\"></QueryTimeStats><RelOp NodeId=\"0\" PhysicalOp=\"Top\" LogicalOp=\"Top\" EstimateRows=\"5\" EstimateIO=\"0\" EstimateCPU=\"5e-007\" AvgRowSize=\"4567\" EstimatedTotalSubtreeCost=\"0.00399609\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\"></ColumnReference></OutputList><RunTimeInformation><RunTimeCountersPerThread Thread=\"0\" ActualRows=\"5\" Batches=\"0\" ActualExecutionMode=\"Row\" ActualElapsedms=\"0\" ActualCPUms=\"0\" ActualEndOfScans=\"1\" ActualExecutions=\"1\"></RunTimeCountersPerThread></RunTimeInformation><Top RowCount=\"0\" IsPercent=\"0\" WithTies=\"0\"><TopExpression><ScalarOperator ScalarString=\"(5)\"><Const ConstValue=\"(5)\"></Const></ScalarOperator></TopExpression><RelOp NodeId=\"1\" PhysicalOp=\"Clustered Index Scan\" LogicalOp=\"Clustered Index Scan\" EstimateRows=\"5\" EstimatedRowsRead=\"2.55001e+006\" EstimateIO=\"451.41\" EstimateCPU=\"2.80517\" AvgRowSize=\"4567\" EstimatedTotalSubtreeCost=\"0.00399559\" TableCardinality=\"2.55001e+006\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\"></ColumnReference><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\"></ColumnReference></OutputList><RunTimeInformation><RunTimeCountersPerThread Thread=\"0\" ActualRows=\"5\" Batches=\"0\" ActualExecutionMode=\"Row\" ActualElapsedms=\"0\" ActualCPUms=\"0\" ActualScans=\"1\" ActualLogicalReads=\"5\" ActualPhysicalReads=\"0\" ActualReadAheads=\"0\" ActualLobLogicalReads=\"0\" ActualLobPhysicalReads=\"0\" ActualLobReadAheads=\"0\" ActualRowsRead=\"5\" ActualEndOfScans=\"0\" ActualExecutions=\"1\"></RunTimeCountersPerThread></RunTimeInformation><IndexScan Ordered=\"0\" ForcedIndex=\"0\" ForceScan=\"0\" NoExpandHint=\"0\" Storage=\"RowStore\"><DefinedValues><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\"></ColumnReference></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\"></ColumnReference></DefinedValue></DefinedValues><Object Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Index=\"[PK_Posts__Id]\" IndexKind=\"Clustered\" Storage=\"RowStore\"></Object></IndexScan></RelOp></Top></RelOp></QueryPlan></StmtSimple></Statements></Batch></BatchSequence></ShowPlanXML>";
            const string fromQueryStoreShowPlan = "<ShowPlanXML xmlns=\"http://schemas.microsoft.com/sqlserver/2004/07/showplan\" Version=\"1.6\" Build=\"14.0.1000.169\"><BatchSequence><Batch><Statements><StmtSimple StatementText=\"select top 5 * from users\" StatementId=\"1\" StatementCompId=\"1\" StatementType=\"SELECT\" RetrievedFromCache=\"true\" StatementSubTreeCost=\"0.00334715\" StatementEstRows=\"5\" SecurityPolicyApplied=\"false\" StatementOptmLevel=\"TRIVIAL\" QueryHash=\"0x1BBA1917F307A0B7\" QueryPlanHash=\"0xD8B9D2461B0B7537\" CardinalityEstimationModelVersion=\"140\"><StatementSetOptions QUOTED_IDENTIFIER=\"true\" ARITHABORT=\"true\" CONCAT_NULL_YIELDS_NULL=\"true\" ANSI_NULLS=\"true\" ANSI_PADDING=\"true\" ANSI_WARNINGS=\"true\" NUMERIC_ROUNDABORT=\"false\" /><QueryPlan CachedPlanSize=\"24\" CompileTime=\"0\" CompileCPU=\"0\" CompileMemory=\"112\"><MemoryGrantInfo SerialRequiredMemory=\"0\" SerialDesiredMemory=\"0\" /><OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant=\"209144\" EstimatedPagesCached=\"209144\" EstimatedAvailableDegreeOfParallelism=\"8\" MaxCompileMemory=\"13102120\" /><RelOp NodeId=\"0\" PhysicalOp=\"Top\" LogicalOp=\"Top\" EstimateRows=\"5\" EstimateIO=\"0\" EstimateCPU=\"5e-007\" AvgRowSize=\"4468\" EstimatedTotalSubtreeCost=\"0.00334715\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\" /></OutputList><Top RowCount=\"0\" IsPercent=\"0\" WithTies=\"0\"><TopExpression><ScalarOperator ScalarString=\"(5)\"><Const ConstValue=\"(5)\" /></ScalarOperator></TopExpression><RelOp NodeId=\"1\" PhysicalOp=\"Clustered Index Scan\" LogicalOp=\"Clustered Index Scan\" EstimateRows=\"5\" EstimatedRowsRead=\"524491\" EstimateIO=\"7.75868\" EstimateCPU=\"0.577097\" AvgRowSize=\"4468\" EstimatedTotalSubtreeCost=\"0.00334665\" TableCardinality=\"524491\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\" /></OutputList><IndexScan Ordered=\"0\" ForcedIndex=\"0\" ForceScan=\"0\" NoExpandHint=\"0\" Storage=\"RowStore\"><DefinedValues><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Id\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AboutMe\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Age\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"CreationDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DisplayName\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"DownVotes\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"EmailHash\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"LastAccessDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Location\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Reputation\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"UpVotes\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"Views\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"WebsiteUrl\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Column=\"AccountId\" /></DefinedValue></DefinedValues><Object Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Users]\" Index=\"[PK_Users_Id]\" IndexKind=\"Clustered\" Storage=\"RowStore\" /></IndexScan></RelOp></Top></RelOp></QueryPlan></StmtSimple><StmtSimple StatementText=\"&#xD;&#xA;select top 5 * from posts\" StatementId=\"2\" StatementCompId=\"2\" StatementType=\"SELECT\" RetrievedFromCache=\"true\" StatementSubTreeCost=\"0.00399609\" StatementEstRows=\"5\" SecurityPolicyApplied=\"false\" StatementOptmLevel=\"TRIVIAL\" QueryHash=\"0xA412098E2F9DD081\" QueryPlanHash=\"0xFA74B1C0F38BCAFE\" CardinalityEstimationModelVersion=\"140\"><StatementSetOptions QUOTED_IDENTIFIER=\"true\" ARITHABORT=\"true\" CONCAT_NULL_YIELDS_NULL=\"true\" ANSI_NULLS=\"true\" ANSI_PADDING=\"true\" ANSI_WARNINGS=\"true\" NUMERIC_ROUNDABORT=\"false\" /><QueryPlan CachedPlanSize=\"24\" CompileTime=\"0\" CompileCPU=\"0\" CompileMemory=\"144\"><MemoryGrantInfo SerialRequiredMemory=\"0\" SerialDesiredMemory=\"0\" /><OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant=\"209144\" EstimatedPagesCached=\"209144\" EstimatedAvailableDegreeOfParallelism=\"8\" MaxCompileMemory=\"13102120\" /><RelOp NodeId=\"0\" PhysicalOp=\"Top\" LogicalOp=\"Top\" EstimateRows=\"5\" EstimateIO=\"0\" EstimateCPU=\"5e-007\" AvgRowSize=\"4567\" EstimatedTotalSubtreeCost=\"0.00399609\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\" /></OutputList><Top RowCount=\"0\" IsPercent=\"0\" WithTies=\"0\"><TopExpression><ScalarOperator ScalarString=\"(5)\"><Const ConstValue=\"(5)\" /></ScalarOperator></TopExpression><RelOp NodeId=\"1\" PhysicalOp=\"Clustered Index Scan\" LogicalOp=\"Clustered Index Scan\" EstimateRows=\"5\" EstimatedRowsRead=\"2.55001e+006\" EstimateIO=\"451.41\" EstimateCPU=\"2.80517\" AvgRowSize=\"4567\" EstimatedTotalSubtreeCost=\"0.00399559\" TableCardinality=\"2.55001e+006\" Parallel=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimatedExecutionMode=\"Row\"><OutputList><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\" /><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\" /></OutputList><IndexScan Ordered=\"0\" ForcedIndex=\"0\" ForceScan=\"0\" NoExpandHint=\"0\" Storage=\"RowStore\"><DefinedValues><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Id\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AcceptedAnswerId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"AnswerCount\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Body\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ClosedDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommentCount\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CommunityOwnedDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"CreationDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"FavoriteCount\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastActivityDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditDate\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorDisplayName\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"LastEditorUserId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"OwnerUserId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ParentId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"PostTypeId\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Score\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Tags\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"Title\" /></DefinedValue><DefinedValue><ColumnReference Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Column=\"ViewCount\" /></DefinedValue></DefinedValues><Object Database=\"[StackOverflowMath]\" Schema=\"[dbo]\" Table=\"[Posts]\" Index=\"[PK_Posts__Id]\" IndexKind=\"Clustered\" Storage=\"RowStore\" /></IndexScan></RelOp></Top></RelOp></QueryPlan></StmtSimple></Statements></Batch></BatchSequence></ShowPlanXML>";

            var better = ShowplanFixer.ApplyBetterStatement(originalShowPlan, fromQueryStoreShowPlan, out var statementText);
            
            statementText.ShouldBe("select top 5 * from posts");

            var xml = new XmlDocument();
            xml.LoadXml(better);

            var statement = xml.GetElementsByTagName("StmtSimple")[0];

            statement.Name.ShouldBe("StmtSimple");
            statement.Attributes?["StatementText"].ShouldNotBeNull();
            statement.Attributes?["StatementText"].Value.Trim().ShouldBe("select top 5 * from posts");
            
            var setOptions = statement.ChildNodes.Cast<XmlNode>().FirstOrDefault(i => i.Name == "StatementSetOptions");
            setOptions.ShouldNotBeNull();
            setOptions.Attributes?.Count.ShouldBe(8);
        }
    }
}
